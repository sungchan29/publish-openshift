```bash

vi abi-03-create-file-04-vulnerability-mitigation-configs.sh

```

```bash
#!/bin/bash

# Source the abi-01-config-preparation-01-general.sh file
if [[ -f ./abi-01-config-preparation-01-general.sh ]]; then
    source "./abi-01-config-preparation-01-general.sh"
else
    echo "ERROR: Cannot access './abi-01-config-preparation-01-general.sh'. File or directory does not exist. Exiting..."
    exit 1
fi

if [[ -z "${OCP_VERSION}" ]]; then
    echo "Error: OCP_VERSION variable is empty. Exiting..."
    exit 1
fi

if [[ -z "${CLUSTER_NAME}" ]]; then
    echo "Error: CLUSTER_NAME variable is empty. Exiting..."
    exit 1
fi
if [[ -z "${CLUSTER_NAME}" ]]; then
    echo "Error: CLUSTER_NAME variable is empty. Exiting..."
    exit 1
fi

#####################
#####################
#####################

if [[ -f ./abi-01-config-preparation-02-vulnerability-mitigation-text.sh ]]; then
    sh ./abi-01-config-preparation-02-vulnerability-mitigation-text.sh
else
    echo "ERROR: The file './abi-01-config-preparation-02-vulnerability-mitigation-text.sh' does not exist. Exiting..."
    echo "To resolve this issue, ensure the script exists and is accessible:"
    echo "  1. Create the file if it doesn't exist."
    echo "  2. Verify the file path and permissions."
    echo "  3. Retry execution after addressing the above issues."
    exit 1
fi

# Check if the specified directory exists
if [[ ! -d "./${CLUSTER_NAME}/orig/openshift" ]]; then
    echo "ERROR: The directory or file './${CLUSTER_NAME}/orig/openshift' does not exist."
    echo "Please ensure the directory exists or execute the following command to create it:"
    echo "sh abi-03-create-file-03-openshift-configs.sh"
    exit 1
fi

# Check if the file './${CLUSTER_NAME}/orig/install-config.yaml' exists
if [[ ! -f "./${CLUSTER_NAME}/orig/install-config.yaml" ]]; then
    echo "ERROR: The file './${CLUSTER_NAME}/orig/install-config.yaml' does not exist. Exiting..."
    echo "To resolve this issue, execute the following command:"
    echo "sh abi-03-create-file-02-install-config.sh"
    exit 1
fi

# Check if the file './${CLUSTER_NAME}/orig/agent-config.yaml' exists
if [[ ! -f "./${CLUSTER_NAME}/orig/agent-config.yaml" ]]; then
    echo "ERROR: The file './${CLUSTER_NAME}/orig/agent-config.yaml' does not exist. Exiting..."
    echo "To resolve this issue, execute the following command:"
    echo "sh abi-03-create-file-01-agent-config.sh"
    exit 1
fi

# Check if the file './butane' exists
if [[ ! -f "./butane" ]]; then
    echo "ERROR: The file './butane' does not exist. Exiting..."
    echo "Attempting to resolve the issue by executing the required script..."
    ehco "sh abi-02-install-openshift-tools.sh"
    exit 1
fi

# Check if the specified directory exists
if [[ ! -d "$VULNERABILITY_MITIGATION_TEXT" ]]; then
    echo "ERROR: The directory or file '$VULNERABILITY_MITIGATION_TEXT' does not exist."
    echo "Please ensure the directory exists or execute the following command to create it:"
    echo "sh abi-01-config-preparation-02-create-file-vulnerability-mitigation-text.sh"
    exit 1
fi

#####################
#####################
#####################

butane_ocp_version="$(echo $OCP_VERSION |awk '{print $NF}' |sed 's/\.[0-9]*$/\.0/')"

### 1. Banner
###    https://access.redhat.com/solutions/6806681
if [[ -f ${VULNERABILITY_MITIGATION_TEXT}/custom-banner.txt ]]; then
    for role in "master" "worker"; do

cat <<EOF > ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-banner.bu
variant: openshift
version: $butane_ocp_version
metadata:
  name: 99-${role}-custom-banner
  labels:
    machineconfiguration.openshift.io/role: ${role}
storage:
  files:
  - path: /etc/motd
    mode: 0644
    overwrite: true
    contents:
      source: data:text/plain;charset=utf-8;base64,$(base64 -w0 ${VULNERABILITY_MITIGATION_TEXT}/custom-banner.txt)
EOF

        ./butane ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-banner.bu -o ./${CLUSTER_NAME}/orig/openshift/99-${role}-vulnerability-mitigation-banner.yaml
    done
fi

### 2. Password Policy
if [[ -f ${VULNERABILITY_MITIGATION_TEXT}/etc_security_pwquality.txt ]]; then
    for role in "master" "worker"; do

cat <<EOF > ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-password-policy.bu
variant: openshift
version: $butane_ocp_version
metadata:
  name: 99-${role}-custom-password-policy
  labels:
    machineconfiguration.openshift.io/role: ${role}
storage:
  files:
  - path: /etc/security/pwquality.conf
    mode: 0644
    overwrite: true
    contents:
      source: data:text/plain;charset=utf-8;base64,$(base64 -w0 ${VULNERABILITY_MITIGATION_TEXT}/etc_security_pwquality.txt)
EOF

        ./butane ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-password-policy.bu -o ./${CLUSTER_NAME}/orig/openshift/99-${role}-vulnerability-mitigation-password-policy.yaml
    done
fi

### 3. PAM (Pluggable Authentication Modules)
###    https://access.redhat.com/solutions/7012977
###    pam_faillock.so: Locks the account after 5 failed login attempts for 120 seconds.

if [[ -f ${VULNERABILITY_MITIGATION_TEXT}/etc_pam.d_password-auth_edit.txt && -f ${VULNERABILITY_MITIGATION_TEXT}/etc_pam.d_system-auth_edit.txt ]]; then
    for role in "master" "worker"; do

cat <<EOF > ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-pam-auth-account-password.bu
variant: openshift
version: $butane_ocp_version
metadata:
  name: 99-${role}-custom-pam-auth-account-password
  labels:
    machineconfiguration.openshift.io/role: ${role}
storage:
  files:
  - path: /etc/pam.d/password-auth
    mode: 0644
    overwrite: true
    contents:
      source: data:text/plain;charset=utf-8;base64,$(base64 -w0 ${VULNERABILITY_MITIGATION_TEXT}/etc_pam.d_password-auth_edit.txt)
  - path: /etc/pam.d/system-auth
    mode: 0644
    overwrite: true
    contents:
      source: data:text/plain;charset=utf-8;base64,$(base64 -w0 ${VULNERABILITY_MITIGATION_TEXT}/etc_pam.d_system-auth_edit.txt)
EOF

        ./butane ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-pam-auth-account-password.bu -o ./${CLUSTER_NAME}/orig/openshift/99-${role}-vulnerability-mitigation-pam-auth-account-password.yaml
    done
fi

### 4. Own Change
if [[ -f ${VULNERABILITY_MITIGATION_TEXT}/own-change-files.txt ]]; then
    OWN_CHANGE_TARGET=$(cat ${VULNERABILITY_MITIGATION_TEXT}/own-change-files.txt | sed 's/^ *//;s/ *$//' | tr '\n' ' ' | sed 's/ *$//')
    
    for role in "master" "worker"; do

cat << EOF > ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-own-change.bu
variant: openshift
version: $butane_ocp_version
metadata:
  name: 99-${role}-custom-own-change
  labels:
    machineconfiguration.openshift.io/role: ${role}
systemd:
  units:
  - contents: |
      [Unit]
      Description=Change own from .bashrc and bash_profile
      Before=kubelet.service

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c '/usr/bin/chmod o-r ${OWN_CHANGE_TARGET}'
      RemainAfterExit=true

      [Install]
      WantedBy=multi-user.target
    enabled: true
    name: custom-own-change.service
EOF

        ./butane ./${CLUSTER_NAME}/orig/99-${role}-vulnerability-mitigation-own-change.bu -o ./${CLUSTER_NAME}/orig/openshift/99-${role}-vulnerability-mitigation-own-change.yaml
    done
fi
```

```bash

sh abi-03-create-file-04-vulnerability-mitigation-configs.sh

```