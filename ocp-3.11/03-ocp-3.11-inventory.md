# OpenShift 3.11 설치를 위한 Ansible Inventory 구성

이 문서는 OpenShift Container Platform 3.11 설치에 사용되는 최종 Ansible 인벤토리 파일(`ose-v3.11.784-inventory-hosts`)의 전체 구성을 설명합니다. 각 변수는 기능별로 그룹화되어 있으며, 고가용성(HA) 및 오프라인(Disconnected) 환경을 기준으로 작성되었습니다.

## 참고 자료 (References)

  * [Red Hat: Configuring the Inventory File](https://docs.redhat.com/en/documentation/openshift_container_platform/3.11/html/installing_clusters/install-config-configuring-inventory-file)
  * [Red Hat: Advanced Installation Variables](https://www.google.com/search?q=https://docs.redhat.com/en/documentation/openshift_container_platform/3.11/html/advanced_installation/adv-install-cluster-variables)
  * [Red Hat: Installing Cluster Metrics](https://www.google.com/search?q=https://docs.redhat.com/en/documentation/openshift_container_platform/3.11/html/installing_and_configuring_cluster_metrics/installing-cluster-metrics)
  * [GitHub: OpenShift Ansible Inventory Example](https://github.com/openshift/openshift-ansible/blob/release-3.11/inventory/hosts.example)

-----

## `[OSEv3:children]`

설치에 포함될 모든 호스트 그룹(masters, nodes, etcd, new\_nodes)을 정의하는 최상위 그룹입니다.

```ini
[OSEv3:children]
masters
nodes
etcd
```

## `[OSEv3:vars]`

클러스터 전체에 적용되는 글로벌 변수를 설정하는 핵심 영역입니다.

### 기본 클러스터 및 버전 설정

Ansible 접속 계정, OpenShift 배포 유형, 설치할 이미지 및 RPM 버전을 지정합니다.

```ini
ansible_ssh_user=root
ansible_become=true

openshift_deployment_type=openshift-enterprise
debug_level=2

openshift_image_tag=v3.11.784
openshift_pkg_version=-3.11.784
```

### 오프라인/Disconnected 설치 설정

인터넷이 차단된 환경에서 내부 레지스트리를 사용하기 위한 필수 변수입니다.

```ini
osm_etcd_image=bst01.ocp3.cloudpang.lan:5000/rhel7/etcd:3.2.28
oreg_url=bst01.ocp3.cloudpang.lan:5000/openshift3/ose-${component}:${version}
openshift_docker_ent_reg=''
```

### 마스터 및 API/콘솔 설정

마스터 고가용성(HA)을 위한 내부/외부 로드 밸런서 주소와 애플리케이션 라우팅을 위한 기본 서브도메인을 설정합니다.

```ini
openshift_master_api_port=8443
openshift_master_console_port=8443

openshift_master_cluster_method=native
openshift_master_cluster_hostname=master.ocp3.cloudpang.lan
openshift_master_cluster_public_hostname=csmaster.ocp3.cloudpang.lan

openshift_master_default_subdomain=apps.ocp3.cloudpang.lan
```

### Docker 설정

모든 노드에 설치될 Docker 데몬의 옵션을 지정하고, 오프라인 환경을 위해 내부 레지스트리를 신뢰할 수 있도록 설정합니다.

```ini
#docker_version=1.13.1
openshift_docker_insecure_registries='bst01.ocp3.cloudpang.lan:5000,172.32.0.0/16,docker-registry.default.svc:5000'
openshift_docker_options='-l warn --log-opt max-size=20M --log-opt max-file=3'
```

### 네트워크 설정 (SDN)

Pod와 Service가 사용할 네트워크 대역(CIDR)과 SDN(Software Defined Network) 플러그인 종류를 정의합니다.

```ini
os_sdn_network_plugin_name='redhat/openshift-ovs-multitenant'
osm_cluster_network_cidr=172.33.0.0/16
openshift_portal_net=172.32.0.0/16
osm_host_subnet_length=9
```

### 인증서 및 보안 설정

자동 생성되는 인증서의 유효 기간을 늘리고, 노드 CSR(인증서 서명 요청)을 자동 승인하며, 사용자 인증 방식을 `htpasswd`로 설정합니다.

```ini
openshift_ca_cert_expire_days=36500
openshift_node_cert_expire_days=36500
openshift_master_cert_expire_days=36500
etcd_ca_default_days=36500
openshift_hosted_registry_cert_expire_days=36500

openshift_master_bootstrap_auto_approve=true
openshift_master_bootstrap_auto_approver_node_selector={"node-role.kubernetes.io/master":"true"}
osm_controller_args={"experimental-cluster-signing-duration": ["20m"]}

openshift_master_identity_providers=[{'name': 'htpasswd_auth', 'login': 'true', 'challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider'}]
```

### 선택적 컴포넌트 및 애드온 설정

클러스터 모니터링을 위한 영구 저장소(PV)를 활성화하고, 불필요한 서비스 카탈로그나 브로커, 예제 템플릿 등은 비활성화합니다.

```ini
# Cluster Monitoring
openshift_cluster_monitoring_operator_node_selector={'node-role.kubernetes.io/infra':'true'}
openshift_cluster_monitoring_operator_prometheus_storage_enabled=true
openshift_cluster_monitoring_operator_alertmanager_storage_enabled=true
openshift_cluster_monitoring_operator_prometheus_storage_capacity='50Gi'
openshift_cluster_monitoring_operator_alertmanager_storage_capacity='2Gi'

# Other Components
openshift_console_install=true
openshift_hosted_manage_router=false
openshift_hosted_manage_registry=false
openshift_hosted_manage_registry_console=false
openshift_enable_service_catalog=false
template_service_broker_install=false
ansible_service_broker_install=false

# Example Templates
openshift_install_examples=false
openshift_examples_modify_imagestreams=false
```

### 고급 설정 및 설치 검증 비활성화

설치 과정에서 발생할 수 있는 검증(Check) 단계를 건너뛰어 설치 시간을 단축하고, Pod가 배포될 기본 노드를 `compute` 역할로 지정합니다.

```ini
# Hostname validation disabling
openshift_hostname_check=false
openshift_set_hostname=false
openshift_override_hostname_check=false

# Enable unsupported configurations
openshift_enable_unsupported_configurations=false

# Disable specific pre-install checks
openshift_disable_check=memory_availability,disk_availability,docker_image_availability,docker_storage,package_version,package_availability

# Default node selector for project pods
osm_default_node_selector='node-role.kubernetes.io/compute=true'

# Storage plugin dependencies to install
osn_storage_plugin_deps=[]

# Firewall management
os_firewall_use_firewalld=false
```

### 노드 그룹 정의

클러스터에 포함될 노드들의 역할(master, infra, compute 등)과 각 그룹에 부여될 레이블 및 세부 설정을 정의합니다.

```ini
openshift_node_groups=[{'name': 'node-config-master', 'labels': ['node-role.kubernetes.io/master=true']}, {'name': 'node-config-infra', 'labels': ['node-role.kubernetes.io/infra=true']}, {'name': 'node-config-router', 'labels': ['node-role.kubernetes.io/router=true']}, {'name': 'node-config-compute-vm', 'labels': ['node-role.kubernetes.io/compute=true']}, {'name': 'node-config-compute-baremetal', 'labels': ['node-role.kubernetes.io/compute=true']}, {'name': 'node-config-compute', 'labels': ['node-role.kubernetes.io/compute=true'], 'edits': [{ 'key': 'kubeletArguments.pods-per-core','value': ['20']}]}]
```

## 호스트 그룹 정의

각 그룹에 속하는 서버들의 호스트 이름을 지정하고, 노드 역할을 할당합니다. `[new_nodes]` 그룹은 클러스터 확장에 사용됩니다.

```ini
[masters]
mst01.ocp3.cloudpang.lan
mst02.ocp3.cloudpang.lan
mst03.ocp3.cloudpang.lan

[etcd]
mst01.ocp3.cloudpang.lan
mst02.ocp3.cloudpang.lan
mst03.ocp3.cloudpang.lan

[nodes]
mst01.ocp3.cloudpang.lan    openshift_node_group_name="node-config-master"
mst02.ocp3.cloudpang.lan    openshift_node_group_name="node-config-master"
mst03.ocp3.cloudpang.lan    openshift_node_group_name="node-config-master"
ifr01.ocp3.cloudpang.lan    openshift_node_group_name="node-config-infra"
ifr02.ocp3.cloudpang.lan    openshift_node_group_name="node-config-infra"
```

-----

## 📝 인벤토리 파일

```bash
vi ose-v3.11.784-inventory-hosts
```

```ini
################################################################################
###
### OpenShift Container Platform 3.11 Ansible Inventory File
###
### File: ose-v3.11.784-inventory-hosts
###
################################################################################

[OSEv3:children]
masters
nodes
etcd
#new_nodes

[OSEv3:vars]
### ==============================================================================
### Global Variables
### ==============================================================================
ansible_ssh_user=root
ansible_become=true

### ------------------------------------------------------------------------------
### Deployment & Version Settings
### ------------------------------------------------------------------------------
### Set to 'openshift-enterprise' for OpenShift Container Platform
openshift_deployment_type=openshift-enterprise

### Set debug log level (0=errors/warnings, 2=normal, 4=debug, 6=API debug, 8=API body debug)
debug_level=2

### Specify container image tag to install
openshift_image_tag=v3.11.784

### Specify RPM version to install
openshift_pkg_version=-3.11.784

### ------------------------------------------------------------------------------
### Disconnected/Offline Installation Settings
### ------------------------------------------------------------------------------
### For containerized etcd, specify the etcd image on your local registry
osm_etcd_image=bst01.ocp3.cloudpang.lan:5000/rhel7/etcd:3.2.28

### Set to the alternate image location for offline installation
oreg_url=bst01.ocp3.cloudpang.lan:5000/openshift3/ose-${component}:${version}

### Disable use of the default Red Hat registry (registry.redhat.io)
openshift_docker_ent_reg=''

### ------------------------------------------------------------------------------
### Master API, Console, and HA Settings
### ------------------------------------------------------------------------------
### Configure master API and console ports
openshift_master_api_port=8443
openshift_master_console_port=8443

### HA method for multiple masters (native is required)
openshift_master_cluster_method=native

### Internal load balancer hostname for master API access
openshift_master_cluster_hostname=master.ocp3.cloudpang.lan

### External/Public load balancer hostname
openshift_master_cluster_public_hostname=csmaster.ocp3.cloudpang.lan

### Default subdomain for exposed routes (e.g., *.apps.example.com)
openshift_master_default_subdomain=apps.ocp3.cloudpang.lan

### ------------------------------------------------------------------------------
### Docker Settings
### ------------------------------------------------------------------------------
### To specify an exact Docker version (e.g., 1.13.1), uncomment the line below
#docker_version=1.13.1

### Add insecure registries to the Docker configuration
openshift_docker_insecure_registries='bst01.ocp3.cloudpang.lan:5000,172.32.0.0/16,docker-registry.default.svc:5000'

### Configure additional Docker daemon options
openshift_docker_options='-l warn --log-opt max-size=20M --log-opt max-file=3'

### ------------------------------------------------------------------------------
### Network Settings (SDN)
### ------------------------------------------------------------------------------
### OpenShift SDN plug-in to use
os_sdn_network_plugin_name='redhat/openshift-ovs-multitenant'

### SDN cluster network CIDR for Pods
osm_cluster_network_cidr=172.33.0.0/16

### Subnet for Services
openshift_portal_net=172.32.0.0/16

### Per-host subnet length for Pod IPs
osm_host_subnet_length=9

### ------------------------------------------------------------------------------
### Certificate and Security Settings
### ------------------------------------------------------------------------------
### Validity of auto-generated certificates in days
openshift_ca_cert_expire_days=36500
openshift_node_cert_expire_days=36500
openshift_master_cert_expire_days=36500
etcd_ca_default_days=36500
openshift_hosted_registry_cert_expire_days=36500

### Automatic approval of node certificate signing requests (CSRs)
openshift_master_bootstrap_auto_approve=true
openshift_master_bootstrap_auto_approver_node_selector={"node-role.kubernetes.io/master":"true"}
osm_controller_args={"experimental-cluster-signing-duration": ["20m"]}

### Identity provider configuration
openshift_master_identity_providers=[{'name': 'htpasswd_auth', 'login': 'true', 'challenge': 'true', 'kind': 'HTPasswdPasswordIdentityProvider'}]

### ------------------------------------------------------------------------------
### Optional Components and Add-ons
### ------------------------------------------------------------------------------
### Cluster Monitoring Operator
openshift_cluster_monitoring_operator_node_selector={'node-role.kubernetes.io/infra':'true'}
openshift_cluster_monitoring_operator_prometheus_storage_enabled=true
openshift_cluster_monitoring_operator_alertmanager_storage_enabled=true
openshift_cluster_monitoring_operator_prometheus_storage_capacity='50Gi'
openshift_cluster_monitoring_operator_alertmanager_storage_capacity='2Gi'

### Other Components
openshift_console_install=true
openshift_hosted_manage_router=false
openshift_hosted_manage_registry=false
openshift_hosted_manage_registry_console=false
openshift_enable_service_catalog=false
template_service_broker_install=false
ansible_service_broker_install=false

### Example Templates
openshift_install_examples=false
openshift_examples_modify_imagestreams=false

### ------------------------------------------------------------------------------
### Advanced Settings & Pre-install Check Disabling
### ------------------------------------------------------------------------------
### Disable hostname validation checks
openshift_hostname_check=false
openshift_set_hostname=false
openshift_override_hostname_check=false

### Enable unsupported configurations (not for production)
openshift_enable_unsupported_configurations=false

### Disable specific pre-install checks
openshift_disable_check=memory_availability,disk_availability,docker_image_availability,docker_storage,package_version,package_availability

### Default node selector for project pods
osm_default_node_selector='node-role.kubernetes.io/compute=true'

### Storage plugin dependencies to install
osn_storage_plugin_deps=[]

### Firewall management (use firewalld instead of iptables)
os_firewall_use_firewalld=false

### ------------------------------------------------------------------------------
### Node Group Definitions
### ------------------------------------------------------------------------------
openshift_node_groups=[{'name': 'node-config-master', 'labels': ['node-role.kubernetes.io/master=true']}, {'name': 'node-config-infra', 'labels': ['node-role.kubernetes.io/infra=true']}, {'name': 'node-config-router', 'labels': ['node-role.kubernetes.io/router=true']}, {'name': 'node-config-compute-vm', 'labels': ['node-role.kubernetes.io/compute=true']}, {'name': 'node-config-compute-baremetal', 'labels': ['node-role.kubernetes.io/compute=true']}, {'name': 'node-config-compute', 'labels': ['node-role.kubernetes.io/compute=true'], 'edits': [{ 'key': 'kubeletArguments.pods-per-core','value': ['20']}]}]


### ==============================================================================
### Host Group Definitions
### ==============================================================================

[masters]
mst01.ocp3.cloudpang.lan
mst02.ocp3.cloudpang.lan
mst03.ocp3.cloudpang.lan

[etcd]
mst01.ocp3.cloudpang.lan
mst02.ocp3.cloudpang.lan
mst03.ocp3.cloudpang.lan

[nodes]
mst01.ocp3.cloudpang.lan    openshift_node_group_name="node-config-master"
mst02.ocp3.cloudpang.lan    openshift_node_group_name="node-config-master"
mst03.ocp3.cloudpang.lan    openshift_node_group_name="node-config-master"
ifr01.ocp3.cloudpang.lan    openshift_node_group_name="node-config-infra"
ifr02.ocp3.cloudpang.lan    openshift_node_group_name="node-config-infra"

#[new_nodes]
#ifr03.ocp3.cloudpang.lan    openshift_node_group_name="node-config-infra"
#rtr01.ocp3.cloudpang.lan    openshift_node_group_name="node-config-router"
#rtr02.ocp3.cloudpang.lan    openshift_node_group_name="node-config-router"
#wrk01.ocp3.cloudpang.lan    openshift_node_group_name="node-config-compute"
#wrk02.ocp3.cloudpang.lan    openshift_node_group_name="node-config-compute"
#wrk03.ocp3.cloudpang.lan    openshift_node_group_name="node-config-compute-baremetal"
```